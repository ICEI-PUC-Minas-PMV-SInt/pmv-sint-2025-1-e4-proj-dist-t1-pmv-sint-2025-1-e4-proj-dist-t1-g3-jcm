@page
@model jacomiWeb.Pages.UsuariosModel

<h1>Lista de Usuários</h1>

<ul id="usuario-lista"></ul>

<h2>Cadastro de Usuário</h2>
<form onsubmit="event.preventDefault(); saveUsuario();">
    <input type="hidden" id="usuario-id">
    
    <label for="nome">Nome:</label>
    <input type="text" id="nome" required>

    <label for="password">Senha:</label>
    <input type="password" id="password" required>

    <label for="perfil">Perfil:</label>
    <select id="perfil">
        <option value="Administrador">Administrador</option>
        <option value="Usuario">Usuário</option>
    </select>

    <button type="submit">Salvar</button>
</form>

<script>
    const apiUrl = '@(ViewData["ApiUrl"])';

    async function fetchUsuarios() {
        const response = await fetch(`${apiUrl}/api/Usuarios`);
        const usuarios = await response.json();
        const lista = document.getElementById("usuario-lista");
        lista.innerHTML = "";
        
        usuarios.forEach(usuario => {
            lista.innerHTML += `
                <li>${usuario.nome} - ${usuario.perfil}
                <button onclick="editUsuario(${usuario.id})">Editar</button>
                <button onclick="deleteUsuario(${usuario.id})">Excluir</button>
                </li>`;
        });
    }

    async function saveUsuario() {
        const id = document.getElementById("usuario-id").value;
        const nome = document.getElementById("nome").value;
        const password = document.getElementById("password").value;
        const perfil = document.getElementById("perfil").value;

        const novoUsuario = { id, nome, password, perfil };

        const method = id ? "PUT" : "POST";
        await fetch(`${apiUrl}/api/Usuarios/${id || ""}`, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(novoUsuario)
        });

        fetchUsuarios();
    }

    async function editUsuario(id) {
        const response = await fetch(`${apiUrl}/api/Usuarios/${id}`);
        const usuario = await response.json();

        document.getElementById("usuario-id").value = usuario.id;
        document.getElementById("nome").value = usuario.nome;
        document.getElementById("perfil").value = usuario.perfil;
    }

    async function deleteUsuario(id) {
        await fetch(`${apiUrl}/api/Usuarios/${id}`, { method: "DELETE" });
        fetchUsuarios();
    }

    window.onload = fetchUsuarios;
</script>